@*XLSX *@
<script type="text/javascript" src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>


@{
    ViewBag.Title = "EstadoCuenta";

    GMIEntities db = new GMIEntities();
    var oUser = (Usuarios)HttpContext.Current.Session["User"];


    //Fecha del mes.

    int inicioMes = 1;

    int diaMes = DateTime.Today.Day;
    int MES = DateTime.Today.Month;
    int ANIO = DateTime.Today.Year;
    DateTime fechaInicio = DateTime.Today;
    DateTime fechaFinal = DateTime.Today;


    DateTime FECHAI = new DateTime(Convert.ToInt32(ANIO), Convert.ToInt32(MES), inicioMes);
    DateTime FECHAF = new DateTime(Convert.ToInt32(ANIO), Convert.ToInt32(MES), diaMes);
    DateTime FECHAFS = new DateTime(Convert.ToInt32(ANIO), Convert.ToInt32(MES), diaMes);
    TimeSpan difFechas = FECHAF - fechaInicio;


    //VARIABLES DE VIEWBAGS PARA FILTROS
    string canal = "";
    string referido = "";

    //VARIABLES DE TABLA
    var fechaTabla = "";
    var fechaTablaAnterior = "";

    //EPIS NO PAGADOS
    int precioAereo = 0;
    int precioNormalCIVA = 0;
    int precioNormalSIVA = 0;
    int sumaPreciosTotales = 0;
    int sumaPreciosAereos = 0;
    int sumaPreciosNormalesSIVA = 0;
    int sumaPreciosNormalesCIVA = 0;
    int precioVisual = 0;

    //EPIS PAGADOS
    int precioPAereo = 0;
    int precioPNormalCIVA = 0;
    int precioPNormalSIVA = 0;
    int sumaPreciosPTotales = 0;
    int sumaPreciosPAereos = 0;
    int sumaPreciosPNormalesSIVA = 0;
    int sumaPreciosPNormalesCIVA = 0;
    int precioPVisual = 0;

    //PAGO DE GESTORES
    int pagoVisual = 0;
    var fechadePago = "";

    //FOOTERS
    int totalEpis = 0;
    int saldoTotalImporte = 0;
    int totalEpisP = 0;
    int saldoTotalP = 0;
    int totalPago = 0;

    //FECHA ACTUAL
    DateTime FechaAhora = DateTime.Now;

    string nombreExcel = "ESTADO DE CUENTA";


    if (ViewBag.FechaInicio != null)
    {
        fechaInicio = Convert.ToDateTime(ViewBag.FechaInicio);
        DateTime parset = fechaInicio.AddMonths(1).AddDays(-1);

        fechaFinal = parset;
        FECHAF = fechaFinal;
        FECHAFS = FECHAF;
    }

    else
    {

        fechaInicio = FECHAI;
        fechaFinal = FECHAF;
        FECHAFS = FECHAF;
        fechaFinal = fechaFinal.AddDays(1);

    }

    if (ViewBag.FechaFinal != null)
    {
        fechaFinal = Convert.ToDateTime(ViewBag.FechaFinal);
        FECHAFS = fechaFinal;
        fechaFinal = fechaFinal.AddDays(1);
    }

    else
    {

        fechaFinal = FECHAF;
        FECHAFS = FECHAF;
        fechaFinal = fechaFinal.AddDays(1);

    }



    //QUERYS TABLA REGISTROS

    var modeloNormal = db.Paciente.Join(db.Cita, n => n.idPaciente, m => m.idPaciente, (n, m) => new { N = n, M = m }).
Join(db.Captura, a => a.M.idPaciente, b => b.idPaciente, (a, b) => new { A = a, B = b }).
Where(s => s.B.EstatusCaptura == "Terminado" && s.A.M.Asistencia == null && s.A.M.FechaCita >= fechaInicio && s.A.M.FechaCita <= fechaFinal
&& s.A.M.TipoTramite != "REVALORACIÓN").OrderBy(o => o.A.M.Cuenta);


    var modeloAlternativo = db.PacienteESP.
        Where(s => s.EstatusCaptura == "Terminado" && s.FechaCita >= fechaInicio && s.FechaCita <= fechaFinal
        && s.TipoTramite != "REVALORACIÓN" && s.Asistencia == null).OrderBy(o => o.Cuenta);


    var modeloExcelNormal = db.Paciente.Join(db.Cita, n => n.idPaciente, m => m.idPaciente, (n, m) => new { N = n, M = m }).
        Join(db.Captura, a => a.M.idPaciente, b => b.idPaciente, (a, b) => new { A = a, B = b }).
        Where(s => s.B.EstatusCaptura == "Terminado" && s.A.M.Asistencia == null && s.A.M.FechaCita >= fechaInicio && s.A.M.FechaCita <= fechaFinal
        && s.A.M.TipoTramite != "REVALORACIÓN").OrderBy(o => o.A.M.Cuenta);


    var modeloExcelAlternativo = db.PacienteESP.
        Where(s => s.EstatusCaptura == "Terminado" && s.FechaCita >= fechaInicio && s.FechaCita <= fechaFinal
        && s.TipoTramite != "REVALORACIÓN" && s.Asistencia == null).OrderBy(o => o.Cuenta);

    var precioEpiGeneral = db.Referido;

    var pagosGestores = db.PagosGestores;



    //QUERYS FILTROS

    //FILTRO CANAL

    if (ViewBag.Canal != "")
    {
        canal = ViewBag.Canal;

        //MODELO DE LOS NORMALES
        modeloNormal = modeloNormal.Where(w => w.B.EstatusCaptura == "Terminado" && w.A.M.Asistencia == null && w.A.M.TipoTramite != "REVALORACIÓN"
        && w.A.M.FechaCita >= fechaInicio && w.A.M.FechaCita <= fechaFinal && w.A.M.CanalTipo.Contains(canal)).OrderBy(o => o.A.M.Cuenta);

        //MODELO ALTERNATIVOS
        modeloAlternativo = modeloAlternativo.Where(w => w.EstatusCaptura == "Terminado" && w.TipoTramite != "REVALORACIÓN"
        && w.FechaCita >= fechaInicio && w.FechaCita <= fechaFinal && w.Asistencia == null && w.CanalTipo.Contains(canal)).OrderBy(o => o.Cuenta);

        //MODELO DE EXCEL NORMALES
        modeloExcelNormal = modeloExcelNormal.Where(w => w.B.EstatusCaptura == "Terminado" && w.A.M.Asistencia == null && w.A.M.TipoTramite != "REVALORACIÓN"
        && w.A.M.FechaCita >= fechaInicio && w.A.M.FechaCita <= fechaFinal && w.A.M.CanalTipo.Contains(canal)).OrderBy(o => o.A.M.Cuenta);

        //MODELO DE EXCEL ALTERNATIVOS
        modeloExcelAlternativo = modeloExcelAlternativo.Where(w => w.EstatusCaptura == "Terminado" && w.TipoTramite != "REVALORACIÓN"
        && w.FechaCita >= fechaInicio && w.FechaCita <= fechaFinal && w.Asistencia == null && w.CanalTipo.Contains(canal)).OrderBy(o => o.Cuenta);
    }


    //FILTRO REFERIDO

    int idReferido = ViewBag.idReferido;

    if (ViewBag.Referido != "" && ViewBag.idReferido != 0)
    {
        referido = ViewBag.Referido;

        //MODELO DE LOS NORMALES
        modeloNormal = modeloNormal.Where(w => w.B.EstatusCaptura == "Terminado" && w.A.M.Asistencia == null && w.A.M.TipoTramite != "REVALORACIÓN"
        && w.A.M.FechaCita >= fechaInicio && w.A.M.FechaCita <= fechaFinal && w.A.M.ReferidoPor.Contains(referido)).OrderBy(o => o.A.M.Cuenta);

        //MODELO ALTERNATIVOS
        modeloAlternativo = modeloAlternativo.Where(w => w.EstatusCaptura == "Terminado" && w.TipoTramite != "REVALORACIÓN"
        && w.FechaCita >= fechaInicio && w.FechaCita <= fechaFinal && w.Asistencia == null && w.ReferidoPor.Contains(referido)).OrderBy(o => o.Cuenta);

        //MODELO DE EXCEL NORMALES
        modeloExcelNormal = modeloExcelNormal.Where(w => w.B.EstatusCaptura == "Terminado" && w.A.M.Asistencia == null && w.A.M.TipoTramite != "REVALORACIÓN"
        && w.A.M.FechaCita >= fechaInicio && w.A.M.FechaCita <= fechaFinal && w.A.M.ReferidoPor.Contains(referido)).OrderBy(o => o.A.M.Cuenta);

        //MODELO DE EXCEL ALTERNATIVOS
        modeloExcelAlternativo = modeloExcelAlternativo.Where(w => w.EstatusCaptura == "Terminado" && w.TipoTramite != "REVALORACIÓN"
        && w.FechaCita >= fechaInicio && w.FechaCita <= fechaFinal && w.Asistencia == null && w.ReferidoPor.Contains(referido)).OrderBy(o => o.Cuenta);

    }
}




@*Referencia estilos para ambas tablas*@

<link rel="stylesheet" type="text/css" href="~/Estilo.css">


@*HEADER O ENCABEZADO*@
<br />
<h2 style="color: white"> Estado de Cuenta</h2>
<br />


@*INPUTS DE FILTROS*@
<form class="form-inline" method="post" enctype="multipart/form-data" action="@Url.Content("~/Contabilidad/EstadoCuenta")">
    <div>

        @*INPUT FILTRO CANAL*@
        <select name="canal" style="font-size:1.5vh; width: 100px" class="form-control">
            @{
                if (ViewBag.Canal == "")
                {
                    <option value="">CANAL</option>
                }
                else
                {
                    <option value="@canal">@canal.ToUpper()</option>
                }
            }
            @{
                foreach (var item in db.Canales)
                {
                    <option value="@item.NombreCanal">@item.NombreCanal</option>
                }
            }
            <option value="">TODOS</option>
        </select>


        @*INPUT FILTRO REFERIDO*@
        <select name="referido" style="font-size: 1.5vh; width: 130px" class="form-control">
            @{
                if (ViewBag.Referido == "" || ViewBag.Referido == null)
                {
                    <option value="">REFERIDO POR</option>
                }
                else
                {
                    <option value="@referido">@referido</option>
                }
            }
            @foreach (var item in db.Referido.OrderBy(o => o.Tipo).ThenBy(o => o.Nombre))
            {
                <option value="@item.idReferido">@item.Nombre -- @item.Tipo</option>
            }
            <option value="">TODOS</option>
        </select>


        @*INPUT FILTROS DE FECHA POR MES*@

        @{

            DateTime ViewBagFechaInicio = Convert.ToDateTime(ViewBag.fechaInicio);
            var SetFechaInicio = ViewBagFechaInicio.Date.ToString("yyyy-MM");

            if (ViewBag.fechaInicio != null)
            {

                <input type="month" name="fechaInicio" class="form-control" value="@SetFechaInicio" style="width: 160px;" />

            }

            else

            {

                <input type="month" name="fechaInicio" class="form-control" value="" style="width: 160px;" />

            }

        }

        @{

            DateTime ViewBagFechaFinal = Convert.ToDateTime(ViewBag.fechaFinal);
            var SetFechaFinal = ViewBagFechaFinal.Date.ToString("yyyy-MM-dd");

            if (ViewBag.fechaFinal != null)
            {

                <input type="hidden" name="fechaFinal" class="form-control" value="@SetFechaFinal" style="width: 160px;" />

            }

            else

            {

                <input type="hidden" name="fechaFinal" class="form-control" value="" style="width: 160px;" />

            }

        }
        <input type="submit" class="btn btn-info" value="Enviar" />

        <a href="~/Contabilidad/EstadoCuenta">
            <span type="button" class="btn btn-success">Limpiar</span>
        </a>
    </div>
</form>


@*EXPORTAR PDF Y REGRESO A PAGOS*@
<script>
    function ExportToExcel(type, fn, dl)
    {
        var elt = document.getElementById('tbl_exporttable_to_xls');
        var wb = XLSX.utils.table_to_book(elt, { sheet: "sheet1" });
        return dl ?
            XLSX.write(wb, { bookType: type, bookSST: true, type: 'base64' }) :
            XLSX.writeFile(wb, fn || ('@nombreExcel' + ' del @Convert.ToDateTime(fechaInicio).ToString("dd-MM-yy")' + ' al @Convert.ToDateTime(fechaFinal).AddDays(-1).ToString("dd-MM-yy").' + (type || 'xlsx')));
    }
</script>



|   <div>
    <a href="~/Contabilidad/Pagos">
        <span type="button" class="btn btn-success" style="background-color:dodgerblue">Regresar a Control de Pagos</span>
    </a>
    @*<button style="background-color:limegreen" class="btn btn-info dropdown-toggle" onclick="ExportToExcel('xlsx')">Descargar reporte </button>*@
</div>
<br />



@*TABLA INICIAL/ TABLA QUE DICE ALTERNATIVOS/ENCABEZADOS DE LAS DEMAS TABLAS*@
<div>
    <table>
        <thead>
            <tr>
                <th style="background-color: dodgerblue;" colspan="2"></th>
                <th style="background-color: dodgerblue; " colspan="3">ALTERNATIVOS</th>
                <th style="background-color: dodgerblue; " colspan="2"></th>
            </tr>
            <tr>
                <th style="background-color: yellow;" scope="col">Fecha</th>
                <th style="background-color: yellow;" scope="col">Epis</th>
                <th style="background-color: yellow;" scope="col">Importe</th>
                <th style="background-color: yellow;" scope="col">Epis P</th>
                <th style="background-color: yellow;" scope="col">Importe</th>
                <th style="background-color: yellow;" scope="col">Importe Pagos</th>
                <th style="background-color: yellow;" scope="col">Banco/Efectivo</th>
            </tr>
        </thead>
    </table>
</div>
<br>



@*TABLA PRIMERA SECCION PAGOS SALDO POR MES ANTERIOR*@


@{

    if (canal != "IN SITU" && canal != "GESTOR ALT" && canal != null && canal != "")
    {
        <table cellpadding="0" cellspacing="0" class="table  table-hover tablas table-bordered" style="color: #2F2D6B">
            <thead style="color:white">
                <tr>
                    <th style="background-color: gray;" colspan="2"></th>
                    <th style="background-color: gray; " colspan="3">Operaciones de @fechaInicio.ToString("MMMM")</th>
                    <th style="background-color: gray; " colspan="2"></th>
                </tr>
            </thead>
            <tbody>

                @{
                    foreach (var item in modeloNormal.OrderBy(q => q.A.M.FechaCita))
                    {
                        //VARIABLES PARA FECHAS
                        fechaTabla = Convert.ToDateTime(item.A.M.FechaCita).ToString("dd-MMMM-yy");
                        var parseFechaInicial = DateTime.Parse(fechaTabla);
                        var parseFechaFinal = DateTime.Parse(fechaTabla).AddHours(23).AddMinutes(59);

                        //CONTEO DE EPIS TOTALES
                        int conteoEpisTotales = (from i in modeloNormal where i.A.M.FechaCita >= parseFechaInicial && i.A.M.FechaCita <= parseFechaFinal select i).Count();
                        int conteoEpisAereos = (from i in modeloNormal where i.A.M.FechaCita >= parseFechaInicial && i.A.M.FechaCita <= parseFechaFinal && i.A.M.TipoLicencia == "AEREO" select i).Count();
                        int conteoEpisNormalesCIVA = (from i in modeloNormal
                                                      where i.A.M.FechaCita >= parseFechaInicial && i.A.M.FechaCita <= parseFechaFinal && i.A.M.TipoLicencia != "AEREO"
&& (i.A.M.TipoPago == "Referencía BanBajío" || i.A.M.TipoPago == "Transferencia vía BanBajío" || i.A.M.TipoPago == "Referencia BanBajío" || i.A.M.TipoPago == "Banorte"
|| i.A.M.TipoPago == "REFERENCIA OXXO" || i.A.M.TipoPago == "Referencia OXXO" || i.A.M.TipoPago == "Pago con Tarjeta")
                                                      select i).Count();
                        int conteoEpisNormalesSIVA = (from i in modeloNormal
                                                      where i.A.M.FechaCita >= parseFechaInicial && i.A.M.FechaCita <= parseFechaFinal && i.A.M.TipoLicencia != "AEREO"
&& (i.A.M.TipoPago != "Referencía BanBajío" && i.A.M.TipoPago != "Transferencia vía BanBajío" && i.A.M.TipoPago != "Referencia BanBajío" && i.A.M.TipoPago != "Banorte"
&& i.A.M.TipoPago != "REFERENCIA OXXO" && i.A.M.TipoPago != "Referencia OXXO" && i.A.M.TipoPago != "Pago con Tarjeta")
                                                      select i).Count();

                        //CONTEO DE EPIS PAGADOS
                        int conteoEpisPTotales = (from i in modeloNormal where i.A.M.FechaCita >= parseFechaInicial && i.A.M.FechaCita <= parseFechaFinal && (i.A.M.Cuenta == "BANCOS" || i.A.M.Cuenta == "CONEKTA") select i).Count();
                        int conteoEpisPAereos = (from i in modeloNormal
                                                 where i.A.M.FechaCita >= parseFechaInicial && i.A.M.FechaCita <= parseFechaFinal && i.A.M.TipoLicencia == "AEREO"
&& (i.A.M.Cuenta == "BANCOS" || i.A.M.Cuenta == "CONEKTA")
                                                 select i).Count();
                        int conteoEpisPNormalesCIVA = (from i in modeloNormal
                                                       where i.A.M.FechaCita >= parseFechaInicial && i.A.M.FechaCita <= parseFechaFinal && i.A.M.TipoLicencia != "AEREO"
&& (i.A.M.Cuenta == "BANCOS" || i.A.M.Cuenta == "CONEKTA") && (i.A.M.TipoPago == "Referencía BanBajío" || i.A.M.TipoPago == "Transferencia vía BanBajío"
|| i.A.M.TipoPago == "Referencia BanBajío" || i.A.M.TipoPago == "Banorte" || i.A.M.TipoPago == "REFERENCIA OXXO" || i.A.M.TipoPago == "Referencia OXXO"
|| i.A.M.TipoPago == "Pago con Tarjeta")
                                                       select i).Count();
                        int conteoEpisPNormalesSIVA = (from i in modeloNormal
                                                       where i.A.M.FechaCita >= parseFechaInicial && i.A.M.FechaCita <= parseFechaFinal && i.A.M.TipoLicencia != "AEREO"
&& (i.A.M.Cuenta == "BANCOS" || i.A.M.Cuenta == "CONEKTA") && (i.A.M.TipoPago != "Referencía BanBajío" && i.A.M.TipoPago != "Transferencia vía BanBajío" && i.A.M.TipoPago != "Referencia BanBajío"
&& i.A.M.TipoPago != "Banorte" && i.A.M.TipoPago != "REFERENCIA OXXO" && i.A.M.TipoPago != "Referencia OXXO" && i.A.M.TipoPago != "Pago con Tarjeta")
                                                       select i).Count();

                        //VARIABLES PARA PAGOS EFECTUADOS EN MODULO DE PAGOS

                        var pagoGestor = (from i in pagosGestores where i.Gestor == item.A.M.ReferidoPor && i.Fecha >= parseFechaInicial && i.Fecha <= parseFechaFinal select i);

                        //DIFERENCIAR PRECIOS NO PAGADOS

                        var precioEpi = (from i in precioEpiGeneral where i.Nombre == item.A.M.ReferidoPor && i.Tipo == item.A.M.CanalTipo select i).FirstOrDefault();

                        precioAereo = Convert.ToInt32(precioEpi.PrecioAereo);
                        precioNormalCIVA = Convert.ToInt32(precioEpi.PrecioNormalconIVA);
                        precioNormalSIVA = Convert.ToInt32(precioEpi.PrecioNormal);

                        if (precioEpi.PrecioAereo == null || precioEpi.PrecioAereo == "0")
                        {
                            precioAereo = 3480;
                        }
                        if (precioEpi.PrecioNormalconIVA == null || precioEpi.PrecioNormalconIVA == "0")
                        {
                            precioNormalCIVA = precioNormalSIVA;
                        }

                        sumaPreciosNormalesSIVA = conteoEpisNormalesSIVA * precioNormalSIVA;
                        sumaPreciosNormalesCIVA = conteoEpisNormalesCIVA * precioNormalCIVA;
                        sumaPreciosAereos = conteoEpisAereos * precioAereo;
                        sumaPreciosTotales = sumaPreciosAereos + sumaPreciosNormalesSIVA + sumaPreciosNormalesCIVA;
                        precioVisual = sumaPreciosTotales;

                        //DIFERENCIAR PRECIOS  PAGADOS

                        var precioEpiP = (from i in precioEpiGeneral where i.Nombre == item.A.M.ReferidoPor && i.Tipo == item.A.M.CanalTipo select i).FirstOrDefault();

                        precioPAereo = Convert.ToInt32(precioEpi.PrecioAereo);
                        precioPNormalCIVA = Convert.ToInt32(precioEpi.PrecioNormalconIVA);
                        precioPNormalSIVA = Convert.ToInt32(precioEpi.PrecioNormal);

                        if (precioEpiP.PrecioAereo == null || precioEpiP.PrecioAereo == "0")
                        {
                            precioPAereo = 3480;
                        }
                        if (precioEpiP.PrecioNormalconIVA == null || precioEpiP.PrecioNormalconIVA == "0")
                        {
                            precioPNormalCIVA = precioPNormalSIVA;
                        }

                        sumaPreciosPNormalesSIVA = conteoEpisPNormalesSIVA * precioPNormalSIVA;
                        sumaPreciosPNormalesCIVA = conteoEpisPNormalesCIVA * precioPNormalCIVA;
                        sumaPreciosPAereos = conteoEpisPAereos * precioPAereo;
                        sumaPreciosPTotales = sumaPreciosPAereos + sumaPreciosPNormalesSIVA + sumaPreciosPNormalesCIVA;
                        precioPVisual = sumaPreciosPTotales;

                        foreach (var pagos in pagoGestor)
                        {
                            pagoVisual += Convert.ToInt32(pagos.PagoIngresado);
                            fechadePago = Convert.ToDateTime(pagos.Fecha).ToString("dd-MMMM-yy");
                        }

                        if (fechaTablaAnterior != fechaTabla)
                        {
                            totalEpis = (from i in modeloNormal select i).Count();
                            saldoTotalImporte += precioVisual;
                            totalEpisP = (from i in modeloNormal where (i.A.M.Cuenta == "BANCOS" || i.A.M.Cuenta == "CONEKTA") select i).Count(); ;
                            saldoTotalP += precioPVisual;
                            totalPago += pagoVisual;

                            <tr>

                                @*FECHA DE CITA*@
                                <td>
                                    <span>@fechaTabla</span>
                                </td>

                                @*NUMERO DE EPIS X DIA EN FECHA*@
                                <td>
                                    <span>@conteoEpisTotales</span>
                                </td>

                                @*IMPORTE*@
                                <td>
                                    <span>$@precioVisual.ToString("###,###,###,###")</span>
                                </td>

                                @*EPIS PAGADOS*@

                                @{
                                    if (conteoEpisPTotales != 0)
                                    {
                                        <td>
                                            <span>@conteoEpisPTotales</span>
                                        </td>
                                    }
                                    else
                                    {
                                        <td>
                                        </td>
                                    }
                                }

                                @*IMPORTE EPIS PAGADOS*@

                                @{
                                    if (conteoEpisPTotales != 0)
                                    {
                                        <td>
                                            <span>$@precioPVisual.ToString("###,###,###,###")</span>
                                        </td>
                                    }
                                    else
                                    {
                                        <td>
                                        </td>
                                    }
                                }

                                @*IMPORTE MODULO DE PAGOS*@

                                @{
                                    if (fechaTabla == fechadePago)
                                    {
                                        <td>
                                            <span>$@pagoVisual.ToString("###,###,###,###")</span>
                                        </td>
                                    }
                                    else
                                    {
                                        <td>
                                        </td>
                                    }

                                }
                            </tr>

                            fechaTablaAnterior = fechaTabla;
                            precioVisual = 0;
                            precioAereo = 0;
                            precioNormalSIVA = 0;
                            precioNormalCIVA = 0;
                            pagoVisual = 0;
                        }
                    }
            <tr style="background-color:navajowhite">

                @*FECHA DE CITA*@
                <td>
                    <span><b>TOTAL EPIS</b></span>
                </td>

                @*NUMERO DE EPIS X DIA EN FECHA*@
                <td>
                    <span><b>@totalEpis</b></span>
                </td>

                @*IMPORTE*@
                <td>
                    <span><b>$@saldoTotalImporte.ToString("###,###,###,###")</b></span>
                </td>

                @*EPIS PAGADOS*@


                @{
                    if (totalEpisP != 0)
                    {
                        <td>
                            <span><b>@totalEpisP</b></span>
                        </td>
                    }
                    else
                    {
                        <td>
                        </td>
                    }
                }

                @*IMPORTE EPIS PAGADOS*@

                @{
                    if (saldoTotalP != 0)
                    {
                        <td>
                            <span><b>$@saldoTotalP.ToString("###,###,###,###")</b></span>
                        </td>
                    }
                    else
                    {
                        <td>
                        </td>
                    }
                }

                @*IMPORTE MODULO DE PAGOS*@
                @{
                    if (saldoTotalP != 0)
                    {
                        <td>
                            <span><b>$@totalPago.ToString("###,###,###,###")</b></span>
                        </td>
                    }
                    else
                    {
                        <td>
                        </td>
                    }
                }
            </tr>
                }
            </tbody>
        </table>
    }

    else if (canal == "IN SITU" || canal == "GESTOR ALT")
    {
        <table cellpadding="0" cellspacing="0" class="table  table-hover tablas table-bordered" style="color: #2F2D6B">
            <thead style="color:white">
                <tr>
                    <th style="background-color: gray;" colspan="2"></th>
                    <th style="background-color: gray; " colspan="3">Pagos a Saldo al mes de @fechaInicio.ToString("MMMM")</th>
                    <th style="background-color: gray; " colspan="2"></th>
                </tr>
            </thead>
            <tbody>

                @{
                    foreach (var item in modeloAlternativo.OrderBy(q => q.FechaCita))
                    {
                        //VARIABLES PARA FECHAS
                        fechaTabla = Convert.ToDateTime(item.FechaCita).ToString("dd-MMMM-yy");
                        var parseFechaInicial = DateTime.Parse(fechaTabla);
                        var parseFechaFinal = DateTime.Parse(fechaTabla).AddHours(23).AddMinutes(59);

                        //CONTEO DE EPIS TOTALES
                        int conteoEpisTotales = (from i in modeloAlternativo where i.FechaCita >= parseFechaInicial && i.FechaCita <= parseFechaFinal select i).Count();
                        int conteoEpisAereos = (from i in modeloAlternativo where i.FechaCita >= parseFechaInicial && i.FechaCita <= parseFechaFinal && i.TipoLicencia == "AEREO" select i).Count();
                        int conteoEpisNormalesCIVA = (from i in modeloAlternativo
                                                      where i.FechaCita >= parseFechaInicial && i.FechaCita <= parseFechaFinal && i.TipoLicencia != "AEREO"
&& (i.TipoPago == "Referencía BanBajío" || i.TipoPago == "Transferencia vía BanBajío" || i.TipoPago == "Referencia BanBajío" || i.TipoPago == "Banorte"
|| i.TipoPago == "REFERENCIA OXXO" || i.TipoPago == "Referencia OXXO" || i.TipoPago == "Pago con Tarjeta")
                                                      select i).Count();
                        int conteoEpisNormalesSIVA = (from i in modeloAlternativo
                                                      where i.FechaCita >= parseFechaInicial && i.FechaCita <= parseFechaFinal && i.TipoLicencia != "AEREO"
&& (i.TipoPago != "Referencía BanBajío" && i.TipoPago != "Transferencia vía BanBajío" && i.TipoPago != "Referencia BanBajío" && i.TipoPago != "Banorte"
&& i.TipoPago != "REFERENCIA OXXO" && i.TipoPago != "Referencia OXXO" && i.TipoPago != "Pago con Tarjeta")
                                                      select i).Count();

                        //CONTEO DE EPIS PAGADOS
                        int conteoEpisPTotales = (from i in modeloAlternativo where i.FechaCita >= parseFechaInicial && i.FechaCita <= parseFechaFinal && (i.Cuenta == "BANCOS" || i.Cuenta == "CONEKTA") select i).Count();
                        int conteoEpisPAereos = (from i in modeloAlternativo
                                                 where i.FechaCita >= parseFechaInicial && i.FechaCita <= parseFechaFinal && i.TipoLicencia == "AEREO"
&& (i.Cuenta == "BANCOS" || i.Cuenta == "CONEKTA")
                                                 select i).Count();
                        int conteoEpisPNormalesCIVA = (from i in modeloAlternativo
                                                       where i.FechaCita >= parseFechaInicial && i.FechaCita <= parseFechaFinal && i.TipoLicencia != "AEREO"
&& (i.Cuenta == "BANCOS" || i.Cuenta == "CONEKTA") && (i.TipoPago == "Referencía BanBajío" || i.TipoPago == "Transferencia vía BanBajío"
|| i.TipoPago == "Referencia BanBajío" || i.TipoPago == "Banorte" || i.TipoPago == "REFERENCIA OXXO" || i.TipoPago == "Referencia OXXO"
|| i.TipoPago == "Pago con Tarjeta")
                                                       select i).Count();
                        int conteoEpisPNormalesSIVA = (from i in modeloAlternativo
                                                       where i.FechaCita >= parseFechaInicial && i.FechaCita <= parseFechaFinal && i.TipoLicencia != "AEREO"
&& (i.Cuenta == "BANCOS" || i.Cuenta == "CONEKTA") && (i.TipoPago != "Referencía BanBajío" && i.TipoPago != "Transferencia vía BanBajío" && i.TipoPago != "Referencia BanBajío"
&& i.TipoPago != "Banorte" && i.TipoPago != "REFERENCIA OXXO" && i.TipoPago != "Referencia OXXO" && i.TipoPago != "Pago con Tarjeta")
                                                       select i).Count();

                        //VARIABLES PARA PAGOS EFECTUADOS EN MODULO DE PAGOS

                        var pagoGestor = (from i in pagosGestores where i.Gestor == item.ReferidoPor && i.Fecha >= parseFechaInicial && i.Fecha <= parseFechaFinal select i);

                        //DIFERENCIAR PRECIOS NO PAGADOS

                        var precioEpi = (from i in precioEpiGeneral where i.Nombre == item.ReferidoPor && i.Tipo == item.CanalTipo select i).FirstOrDefault();

                        precioAereo = Convert.ToInt32(precioEpi.PrecioAereo);
                        precioNormalCIVA = Convert.ToInt32(precioEpi.PrecioNormalconIVA);
                        precioNormalSIVA = Convert.ToInt32(precioEpi.PrecioNormal);

                        if (precioEpi.PrecioAereo == null || precioEpi.PrecioAereo == "0")
                        {
                            precioAereo = 3480;
                        }
                        if (precioEpi.PrecioNormalconIVA == null || precioEpi.PrecioNormalconIVA == "0")
                        {
                            precioNormalCIVA = precioNormalSIVA;
                        }

                        sumaPreciosNormalesSIVA = conteoEpisNormalesSIVA * precioNormalSIVA;
                        sumaPreciosNormalesCIVA = conteoEpisNormalesCIVA * precioNormalCIVA;
                        sumaPreciosAereos = conteoEpisAereos * precioAereo;
                        sumaPreciosTotales = sumaPreciosAereos + sumaPreciosNormalesSIVA + sumaPreciosNormalesCIVA;
                        precioVisual = sumaPreciosTotales;

                        //DIFERENCIAR PRECIOS  PAGADOS

                        var precioEpiP = (from i in precioEpiGeneral where i.Nombre == item.ReferidoPor && i.Tipo == item.CanalTipo select i).FirstOrDefault();

                        precioPAereo = Convert.ToInt32(precioEpi.PrecioAereo);
                        precioPNormalCIVA = Convert.ToInt32(precioEpi.PrecioNormalconIVA);
                        precioPNormalSIVA = Convert.ToInt32(precioEpi.PrecioNormal);

                        if (precioEpiP.PrecioAereo == null || precioEpiP.PrecioAereo == "0")
                        {
                            precioPAereo = 3480;
                        }
                        if (precioEpiP.PrecioNormalconIVA == null || precioEpiP.PrecioNormalconIVA == "0")
                        {
                            precioPNormalCIVA = precioPNormalSIVA;
                        }

                        sumaPreciosPNormalesSIVA = conteoEpisPNormalesSIVA * precioPNormalSIVA;
                        sumaPreciosPNormalesCIVA = conteoEpisPNormalesCIVA * precioPNormalCIVA;
                        sumaPreciosPAereos = conteoEpisPAereos * precioPAereo;
                        sumaPreciosPTotales = sumaPreciosPAereos + sumaPreciosPNormalesSIVA + sumaPreciosPNormalesCIVA;
                        precioPVisual = sumaPreciosPTotales;

                        foreach (var pagos in pagoGestor)
                        {
                            pagoVisual += Convert.ToInt32(pagos.PagoIngresado);
                            fechadePago = Convert.ToDateTime(pagos.Fecha).ToString("dd-MMMM-yy");
                        }

                        if (fechaTablaAnterior != fechaTabla)
                        {
                            totalEpis = (from i in modeloAlternativo select i).Count();
                            saldoTotalImporte += precioVisual;
                            totalEpisP = (from i in modeloAlternativo where (i.Cuenta == "BANCOS" || i.Cuenta == "CONEKTA") select i).Count(); ;
                            saldoTotalP += precioPVisual;
                            totalPago += pagoVisual;

                            <tr>

                                @*FECHA DE CITA*@
                                <td>
                                    <span>@fechaTabla</span>
                                </td>

                                @*NUMERO DE EPIS X DIA EN FECHA*@
                                <td>
                                    <span>@conteoEpisTotales</span>
                                </td>

                                @*IMPORTE*@
                                <td>
                                    <span>$@precioVisual.ToString("###,###,###,###")</span>
                                </td>

                                @*EPIS PAGADOS*@

                                @{
                                    if (conteoEpisPTotales != 0)
                                    {
                                        <td>
                                            <span>@conteoEpisPTotales</span>
                                        </td>
                                    }
                                    else
                                    {
                                        <td>
                                        </td>
                                    }
                                }

                                @*IMPORTE EPIS PAGADOS*@

                                @{
                                    if (conteoEpisPTotales != 0)
                                    {
                                        <td>
                                            <span>$@precioPVisual.ToString("###,###,###,###")</span>
                                        </td>
                                    }
                                    else
                                    {
                                        <td>
                                        </td>
                                    }
                                }

                                @*IMPORTE MODULO DE PAGOS*@

                                @{
                                    if (fechaTabla == fechadePago)
                                    {
                                        <td>
                                            <span>$@pagoVisual.ToString("###,###,###,###")</span>
                                        </td>
                                    }
                                    else
                                    {
                                        <td>
                                        </td>
                                    }

                                }
                            </tr>

                            fechaTablaAnterior = fechaTabla;
                            precioVisual = 0;
                            precioAereo = 0;
                            precioNormalSIVA = 0;
                            precioNormalCIVA = 0;
                            pagoVisual = 0;
                        }
                    }
            <tr style="background-color:navajowhite">

                @*FECHA DE CITA*@
                <td>
                    <span><b>TOTAL EPIS</b></span>
                </td>

                @*NUMERO DE EPIS X DIA EN FECHA*@
                <td>
                    <span><b>@totalEpis</b></span>
                </td>

                @*IMPORTE*@
                <td>
                    <span><b>$@saldoTotalImporte.ToString("###,###,###,###")</b></span>
                </td>

                @*EPIS PAGADOS*@

                @{
                    if (totalEpisP != 0)
                    {
                        <td>
                            <span><b>@totalEpisP</b></span>
                        </td>
                    }
                    else
                    {
                        <td>
                        </td>
                    }
                }

                @*IMPORTE EPIS PAGADOS*@

                @{
                    if (saldoTotalP != 0)
                    {
                        <td>
                            <span><b>$@saldoTotalP.ToString("###,###,###,###")</b></span>
                        </td>
                    }
                    else
                    {
                        <td>
                        </td>
                    }
                }

                @*IMPORTE MODULO DE PAGOS*@

                @{
                    if (saldoTotalP != 0)
                    {
                        <td>
                            <span><b>$@totalPago.ToString("###,###,###,###")</b></span>
                        </td>
                    }
                    else
                    {
                        <td>
                        </td>
                    }
                }
            </tr>
                }
            </tbody>
        </table>
    }
}